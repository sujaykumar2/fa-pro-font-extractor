name: Font Awesome Pro Glyph Sync

on:
  workflow_dispatch:
  repository_dispatch:
    types: [figma-trigger]

permissions:
  contents: write

jobs:
  sync-font:
    runs-on: ubuntu-latest

    steps:
      - name: Checkout Repo
        uses: actions/checkout@v4

      - name: Install Python and Dependencies
        run: |
          sudo apt-get update
          pip install fonttools

      - name: Get Latest Font Awesome Version
        id: latest
        run: |
          VERSION=$(curl -s https://api.github.com/repos/FortAwesome/Font-Awesome/releases/latest | jq -r .tag_name)
          echo "Latest version: $VERSION"
          echo "version=$VERSION" >> "$GITHUB_OUTPUT"

      - name: Delete existing glyphs.csv if new version is found
        run: |
          echo "ðŸ§¹ Deleting glyphs.csv (if exists) before regenerating for version ${{ steps.latest.outputs.version }}"
          rm -f glyphs.csv

      - name: Download and Inspect Font Awesome Pro .tgz
        run: |
          VERSION=${{ steps.latest.outputs.version }}
          URL="https://npm.fontawesome.com/@fortawesome/fontawesome-pro/-/fontawesome-pro-${VERSION}.tgz"
          echo "Downloading from: $URL"
          curl -L -H "Authorization: Bearer ${{ secrets.FA_AUTH_TOKEN }}" -o fa-pro.tgz "$URL"

          echo "--- FILE TYPE ---"
          file fa-pro.tgz

          echo "--- FILE SIZE ---"
          ls -lh fa-pro.tgz

          echo "--- FILE HEAD (first 10 lines) ---"
          head -n 10 fa-pro.tgz || true

      - name: Extract .ttf File
        run: |
          mkdir extracted
          tar -xf fa-pro.tgz -C extracted
          find extracted -name "fa-solid-900.ttf" -exec cp {} fa-solid-900.ttf \;

      - name: Extract Unicode & Glyphs
        run: python extract_unicode.py

      - name: Show glyphs.csv contents
        run: cat glyphs.csv || echo "glyphs.csv not found"

      - name: Commit and push changes
        run: |
          git config user.name "github-actions[bot]"
          git config user.email "github-actions[bot]@users.noreply.github.com"
          git add glyphs.csv
          git status
          git diff --cached --quiet || git commit -m "ðŸ”¤ Update glyphs.csv for version ${{ steps.latest.outputs.version }}"
          git push https://x-access-token:${{ secrets.GITHUB_TOKEN }}@github.com/${{ github.repository }} HEAD:main
